#!/bin/bash
#SBATCH --job-name=concatncompress
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=email@ufl.edu
#SBATCH --ntasks=1
#SBATCH --mem=100gb
#SBATCH --nodes=1
#SBATCH --cpus-per-task=20  # 20 CPUs allocated for pigz
#SBATCH --time=24:00:00
#SBATCH --output=concatncompress_%j.log
#SBATCH --error=concatncompress_%j.err
#SBATCH --account=group
#SBATCH --qos=group-b

# Load required modules
module load gcc/5.2.0  # Load the GCC module first
module load pigz/2.4   # Load pigz module for parallel gzip

# Main directory path
MAIN_DIR="/path/to/AtNPR1citrus_seq"

# List of directories to process
directories=("T13-3A" "T13-3B" "T24A" "T26A" "T26B" "T35A" "T35B" "T35HMW" "T57-25A" "T57-25B" "T69A" "T69B")

# Output directory for the concatenated files
OUTPUT_DIR="${MAIN_DIR}/all_raw_qc10"

# Create the output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# Loop through each directory and concatenate files in the fastq_pass directory
for dir in "${directories[@]}"; do
    echo "Processing directory: $dir"
    
    # Define the path to the fastq_pass directory
    FASTQ_PASS_DIR="${MAIN_DIR}/${dir}/fastq_pass"
    
    # Output file path
    OUTPUT_FILE="${OUTPUT_DIR}/${dir}_all_raw.qc10.fastq.gz"
    
    # Skip if the output file already exists
    if [ -f "$OUTPUT_FILE" ]; then
        echo "File $OUTPUT_FILE already exists. Skipping..."
        continue
    fi
    
    # Check if the fastq_pass directory exists
    if [ -d "$FASTQ_PASS_DIR" ]; then
        echo "Found directory: $FASTQ_PASS_DIR"
        
        # Check if there are any .fastq.gz files in the directory
        fastq_files=( "$FASTQ_PASS_DIR"/*.fastq.gz )
        
        if [ ${#fastq_files[@]} -eq 0 ]; then
            echo "No .fastq.gz files found in $FASTQ_PASS_DIR. Skipping to next directory."
            continue
        fi
        
        # Concatenate and compress only if there are files to process
        echo "Concatenating files in $FASTQ_PASS_DIR"
        
        # Concatenating files
        zcat "$FASTQ_PASS_DIR"/*.fastq.gz > "${OUTPUT_DIR}/${dir}_all_raw.qc10.fastq"
        
        # Compressing the concatenated file using pigz (parallel gzip with 20 cores)
        echo "Compressing the concatenated file for $dir using pigz"
        if pigz -p 20 "${OUTPUT_DIR}/${dir}_all_raw.qc10.fastq"; then
            echo "Successfully compressed ${dir}_all_raw.qc10.fastq.gz"
        else
            echo "Error compressing ${dir}_all_raw.qc10.fastq. Skipping to next directory."
            continue
        fi
        
    else
        echo "Directory $FASTQ_PASS_DIR does not exist. Skipping to next directory."
    fi
done

# Special handling for T35-repeats (RT35A, RT35B, RT35C)
T35_REPEATS_DIR="${MAIN_DIR}/T35-repeats"
for subdir in "RT35A" "RT35B" "RT35C"; do
    FASTQ_PASS_SUBDIR="${T35_REPEATS_DIR}/${subdir}/fastq_pass"
    
    echo "Processing subdirectory: $subdir"
    
    # Output file path for the repeats subdirectories
    OUTPUT_FILE_REPEATS="${OUTPUT_DIR}/T35-repeats_${subdir}_all_raw.qc10.fastq.gz"
    
    # Skip if the output file already exists
    if [ -f "$OUTPUT_FILE_REPEATS" ]; then
        echo "File $OUTPUT_FILE_REPEATS already exists. Skipping..."
        continue
    fi
    
    # Check if the subdirectories exist
    if [ -d "$FASTQ_PASS_SUBDIR" ]; then
        echo "Found subdirectory: $FASTQ_PASS_SUBDIR"
        
        # Check if there are any .fastq.gz files in the directory
        fastq_files=( "$FASTQ_PASS_SUBDIR"/*.fastq.gz )
        
        if [ ${#fastq_files[@]} -eq 0 ]; then
            echo "No .fastq.gz files found in $FASTQ_PASS_SUBDIR. Skipping to next subdirectory."
            continue
        fi
        
        # Concatenate and compress only if there are files to process
        echo "Concatenating files in $FASTQ_PASS_SUBDIR"
        
        # Concatenating files
        zcat "$FASTQ_PASS_SUBDIR"/*.fastq.gz > "${OUTPUT_DIR}/T35-repeats_${subdir}_all_raw.qc10.fastq"
        
        # Compressing the concatenated file using pigz (parallel gzip with 20 cores)
        echo "Compressing the concatenated file for T35-repeats_${subdir} using pigz"
        if pigz -p 20 "${OUTPUT_DIR}/T35-repeats_${subdir}_all_raw.qc10.fastq"; then
            echo "Successfully compressed T35-repeats_${subdir}_all_raw.qc10.fastq.gz"
        else
            echo "Error compressing T35-repeats_${subdir}_all_raw.qc10.fastq. Skipping to next subdirectory."
            continue
        fi
        
    else
        echo "Subdirectory $FASTQ_PASS_SUBDIR does not exist. Skipping to next subdirectory."
    fi
done
